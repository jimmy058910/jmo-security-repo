# Docker Compose for JMo Security Diff Workflow
#
# This file defines a 3-service workflow for comparing security scan results:
# 1. baseline-scan: Scans baseline state (e.g., main branch)
# 2. current-scan: Scans current state (e.g., PR branch)
# 3. diff-report: Generates diff report comparing the two
#
# Usage:
#   docker-compose -f docker-compose.diff.yml up
#
# The workflow runs sequentially:
#   baseline-scan → current-scan → diff-report
#
# Results:
#   baseline-results/   - Baseline scan outputs
#   current-results/    - Current scan outputs
#   diff-output/        - Diff reports (HTML, JSON, Markdown, SARIF)

version: '3.8'

services:
  # Service 1: Baseline Scan
  # Scans the baseline state (e.g., main branch commit)
  baseline-scan:
    image: ghcr.io/jimmy058910/jmo-security:latest
    container_name: jmo-baseline-scan
    volumes:
      # Mount source code read-only
      - ./:/scan:ro
      # Mount output directory for baseline results
      - ./baseline-results:/results
    command: >
      scan
      --repo /scan
      --profile-name balanced
      --results-dir /results
      --human-logs
    environment:
      # Optional: Set baseline context
      - JMO_SCAN_LABEL=baseline
    networks:
      - jmo-diff-net

  # Service 2: Current Scan
  # Scans the current state (e.g., PR branch)
  # Depends on baseline-scan to run sequentially
  current-scan:
    image: ghcr.io/jimmy058910/jmo-security:latest
    container_name: jmo-current-scan
    volumes:
      - ./:/scan:ro
      - ./current-results:/results
    command: >
      scan
      --repo /scan
      --profile-name balanced
      --results-dir /results
      --human-logs
    environment:
      - JMO_SCAN_LABEL=current
    depends_on:
      baseline-scan:
        condition: service_completed_successfully
    networks:
      - jmo-diff-net

  # Service 3: Diff Report
  # Generates diff report comparing baseline and current
  # Depends on current-scan to run after both scans complete
  diff-report:
    image: ghcr.io/jimmy058910/jmo-security:latest
    container_name: jmo-diff-report
    volumes:
      # Mount baseline results read-only
      - ./baseline-results:/baseline:ro
      # Mount current results read-only
      - ./current-results:/current:ro
      # Mount output directory for diff reports
      - ./diff-output:/output
    command: >
      diff
      /baseline
      /current
      --format html
      --output /output/diff-report.html
    depends_on:
      current-scan:
        condition: service_completed_successfully
    networks:
      - jmo-diff-net

networks:
  jmo-diff-net:
    driver: bridge

# Optional: Add volumes for persistent results
# volumes:
#   baseline-results:
#   current-results:
#   diff-output:

# Advanced Usage Examples:
#
# 1. Generate all output formats:
#    docker-compose -f docker-compose.diff.yml run --rm diff-report \
#      diff /baseline /current --format json --output /output/diff.json
#
# 2. Filter by severity:
#    docker-compose -f docker-compose.diff.yml run --rm diff-report \
#      diff /baseline /current --format md --severity CRITICAL,HIGH --output /output/diff.md
#
# 3. Show only new findings:
#    docker-compose -f docker-compose.diff.yml run --rm diff-report \
#      diff /baseline /current --format html --only new --output /output/new-findings.html
#
# 4. Use slim image for faster startup:
#    Replace 'ghcr.io/jimmy058910/jmo-security:latest' with
#    'ghcr.io/jimmy058910/jmo-security:slim' in all services
#
# 5. Scan with fast profile (5-10 minutes vs 18-25 minutes):
#    Change '--profile-name balanced' to '--profile-name fast'
#
# 6. Run only baseline scan:
#    docker-compose -f docker-compose.diff.yml up baseline-scan
#
# 7. Run baseline + current scans (skip diff):
#    docker-compose -f docker-compose.diff.yml up baseline-scan current-scan
#
# 8. Clean up results:
#    docker-compose -f docker-compose.diff.yml down -v
#    rm -rf baseline-results/ current-results/ diff-output/

# CI/CD Integration:
#
# GitHub Actions:
#   - name: Run Security Diff
#     run: docker-compose -f docker-compose.diff.yml up --abort-on-container-exit
#
# GitLab CI:
#   security-diff:
#     script:
#       - docker-compose -f docker-compose.diff.yml up --abort-on-container-exit
#     artifacts:
#       paths:
#         - diff-output/

# Troubleshooting:
#
# 1. Permission errors on results directories:
#    mkdir -p baseline-results current-results diff-output
#    chmod 777 baseline-results current-results diff-output
#
# 2. Container fails to start:
#    docker-compose -f docker-compose.diff.yml logs baseline-scan
#
# 3. Diff report empty:
#    - Check that baseline-results/ and current-results/ contain findings.json
#    - Verify scan completed successfully
#
# 4. Out of disk space:
#    docker system prune -a
#    docker volume prune
