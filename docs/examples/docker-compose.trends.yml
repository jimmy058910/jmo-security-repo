# Docker Compose configuration for JMo Security Trend Analysis workflows
#
# This example demonstrates a multi-stage security scanning and trend analysis
# workflow using Docker Compose with persistent volume storage.
#
# Usage:
#   # Run first scan (creates baseline)
#   docker compose -f docker-compose.trends.yml run scan-baseline
#
#   # Run second scan (after making changes)
#   docker compose -f docker-compose.trends.yml run scan-current
#
#   # Analyze trends between scans
#   docker compose -f docker-compose.trends.yml run analyze-trends
#
#   # Export trend reports
#   docker compose -f docker-compose.trends.yml run export-html
#   docker compose -f docker-compose.trends.yml run export-json
#
#   # View developer attribution
#   docker compose -f docker-compose.trends.yml run developers
#
# Features:
#   - Named volumes for persistent SQLite history database
#   - Bind mounts for source code and results
#   - Service dependencies for multi-stage workflows
#   - Environment variable configuration
#   - Multiple scan profiles (fast, balanced, deep)

version: '3.8'

services:
  # ============================================================================
  # Baseline Scan Service
  # ============================================================================
  scan-baseline:
    image: jmo-security:latest
    container_name: jmo-scan-baseline
    volumes:
      # Mount source code (read-only for safety)
      - ./:/scan:ro
      # Mount .git directory for developer attribution (read-only)
      - ./.git:/scan/.git:ro
      # Persistent history database (CRITICAL for trend analysis)
      - jmo-history:/root/.jmo
      # Results output directory
      - ./results:/results
    command: >
      scan
      --repo /scan
      --results-dir /results/baseline
      --profile-name balanced
      --human-logs
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
      - JMO_LOG_LEVEL=INFO
    networks:
      - jmo-network

  # ============================================================================
  # Current Scan Service (after code changes)
  # ============================================================================
  scan-current:
    image: jmo-security:latest
    container_name: jmo-scan-current
    volumes:
      - ./:/scan:ro
      - ./.git:/scan/.git:ro
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      scan
      --repo /scan
      --results-dir /results/current
      --profile-name balanced
      --human-logs
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
      - JMO_LOG_LEVEL=INFO
    networks:
      - jmo-network
    depends_on:
      - scan-baseline

  # ============================================================================
  # Trend Analysis Service
  # ============================================================================
  analyze-trends:
    image: jmo-security:latest
    container_name: jmo-analyze-trends
    volumes:
      - ./:/scan:ro
      - ./.git:/scan/.git:ro
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends analyze
      --days 30
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
      - JMO_LOG_LEVEL=INFO
    networks:
      - jmo-network
    depends_on:
      - scan-current

  # ============================================================================
  # Trend History Service (Show Recent Scans)
  # ============================================================================
  show-history:
    image: jmo-security:latest
    container_name: jmo-show-history
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends show
      --limit 10
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network

  # ============================================================================
  # Regressions Detection Service
  # ============================================================================
  check-regressions:
    image: jmo-security:latest
    container_name: jmo-check-regressions
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends regressions
      --days 7
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - analyze-trends

  # ============================================================================
  # Security Score Service
  # ============================================================================
  security-score:
    image: jmo-security:latest
    container_name: jmo-security-score
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends score
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network

  # ============================================================================
  # Developer Attribution Service
  # ============================================================================
  developers:
    image: jmo-security:latest
    container_name: jmo-developers
    volumes:
      - ./:/scan:ro
      - ./.git:/scan/.git:ro  # REQUIRED for git blame
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends developers
      --limit 10
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network

  # ============================================================================
  # Export HTML Report Service
  # ============================================================================
  export-html:
    image: jmo-security:latest
    container_name: jmo-export-html
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends export html
      --output /results/trends-report.html
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - analyze-trends

  # ============================================================================
  # Export JSON Report Service
  # ============================================================================
  export-json:
    image: jmo-security:latest
    container_name: jmo-export-json
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends export json
      --output /results/trends-data.json
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - analyze-trends

  # ============================================================================
  # Export CSV Service (for Excel/BI tools)
  # ============================================================================
  export-csv:
    image: jmo-security:latest
    container_name: jmo-export-csv
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends export csv
      --output /results/trends-data.csv
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - analyze-trends

  # ============================================================================
  # Prometheus Metrics Export Service
  # ============================================================================
  export-prometheus:
    image: jmo-security:latest
    container_name: jmo-export-prometheus
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends export prometheus
      --output /results/metrics.prom
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - analyze-trends

  # ============================================================================
  # Compare Scans Service (Interactive Diff)
  # ============================================================================
  compare-scans:
    image: jmo-security:latest
    container_name: jmo-compare-scans
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends compare
      --scan-id-1 latest
      --scan-id-2 previous
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network
    depends_on:
      - scan-current

  # ============================================================================
  # Remediation Velocity Service
  # ============================================================================
  remediation-velocity:
    image: jmo-security:latest
    container_name: jmo-remediation-velocity
    volumes:
      - jmo-history:/root/.jmo
      - ./results:/results
    command: >
      trends velocity
      --days 30
      --format text
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
    networks:
      - jmo-network

  # ============================================================================
  # Full Workflow Service (Scan + Analyze + Export)
  # ============================================================================
  full-workflow:
    image: jmo-security:latest
    container_name: jmo-full-workflow
    volumes:
      - ./:/scan:ro
      - ./.git:/scan/.git:ro
      - jmo-history:/root/.jmo
      - ./results:/results
    # Use shell script to chain commands
    entrypoint: /bin/bash
    command: >
      -c "
      jmo scan --repo /scan --results-dir /results/latest --profile-name balanced --human-logs &&
      jmo trends analyze --days 30 --format text &&
      jmo trends export html --output /results/trends-report.html &&
      jmo trends export json --output /results/trends-data.json &&
      echo 'Full workflow complete! Check results/ for outputs.'
      "
    environment:
      - JMO_HISTORY_DB_PATH=/root/.jmo/history.db
      - JMO_LOG_LEVEL=INFO
    networks:
      - jmo-network

# ============================================================================
# Volumes
# ============================================================================
volumes:
  # Named volume for persistent SQLite history database
  # CRITICAL: This volume persists across container runs, enabling trend analysis
  jmo-history:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/.jmo

# ============================================================================
# Networks
# ============================================================================
networks:
  jmo-network:
    driver: bridge

# ============================================================================
# Usage Examples
# ============================================================================
#
# Example 1: Basic Workflow (Baseline + Current + Analysis)
# ---------------------------------------------------------
# docker compose -f docker-compose.trends.yml run scan-baseline
# docker compose -f docker-compose.trends.yml run scan-current
# docker compose -f docker-compose.trends.yml run analyze-trends
#
# Example 2: Export All Reports
# ------------------------------
# docker compose -f docker-compose.trends.yml run export-html
# docker compose -f docker-compose.trends.yml run export-json
# docker compose -f docker-compose.trends.yml run export-csv
# docker compose -f docker-compose.trends.yml run export-prometheus
#
# Example 3: Check for Regressions
# ---------------------------------
# docker compose -f docker-compose.trends.yml run check-regressions
#
# Example 4: View Developer Attribution
# --------------------------------------
# docker compose -f docker-compose.trends.yml run developers
#
# Example 5: Full Automated Workflow
# -----------------------------------
# docker compose -f docker-compose.trends.yml run full-workflow
#
# Example 6: Compare Two Scans
# -----------------------------
# docker compose -f docker-compose.trends.yml run compare-scans
#
# Example 7: CI/CD Integration (GitHub Actions)
# ----------------------------------------------
# - name: Run Security Scan with Trends
#   run: |
#     docker compose -f docker-compose.trends.yml run scan-current
#     docker compose -f docker-compose.trends.yml run analyze-trends
#     docker compose -f docker-compose.trends.yml run export-html
#
# - name: Upload Trend Report
#   uses: actions/upload-artifact@v4
#   with:
#     name: security-trends
#     path: results/trends-report.html
#
# Example 8: CI/CD Integration (GitLab CI)
# -----------------------------------------
# security-scan:
#   image: docker/compose:latest
#   script:
#     - docker compose -f docker-compose.trends.yml run scan-current
#     - docker compose -f docker-compose.trends.yml run analyze-trends
#     - docker compose -f docker-compose.trends.yml run export-html
#   artifacts:
#     paths:
#       - results/trends-report.html
#     expire_in: 30 days
#
# Example 9: Local Development Workflow
# --------------------------------------
# # Daily scan during development
# docker compose -f docker-compose.trends.yml run scan-current
#
# # Check weekly trends
# docker compose -f docker-compose.trends.yml run analyze-trends
#
# # Monthly review
# docker compose -f docker-compose.trends.yml run export-html
# open results/trends-report.html
#
# Example 10: Volume Management
# ------------------------------
# # Inspect history database
# docker compose -f docker-compose.trends.yml run --rm -v jmo-history:/data busybox ls -lh /data
#
# # Backup history database
# docker compose -f docker-compose.trends.yml run --rm \
#   -v jmo-history:/data -v $(pwd):/backup busybox \
#   tar czf /backup/history-backup.tar.gz -C /data .
#
# # Restore history database
# docker compose -f docker-compose.trends.yml run --rm \
#   -v jmo-history:/data -v $(pwd):/backup busybox \
#   tar xzf /backup/history-backup.tar.gz -C /data
#
# ============================================================================
# Troubleshooting
# ============================================================================
#
# Issue: "No scans found in history database"
# Solution: Run scan-baseline first to create initial scan data
#
# Issue: "Permission denied" when accessing .jmo volume
# Solution: Ensure .jmo directory exists with correct permissions:
#   mkdir -p .jmo && chmod 755 .jmo
#
# Issue: "Git repository not found" for developer attribution
# Solution: Ensure .git directory is mounted and accessible:
#   - ./.git:/scan/.git:ro
#
# Issue: Docker Compose version compatibility
# Solution: Use Docker Compose v2 syntax:
#   docker compose (not docker-compose)
#
# Issue: Volume persistence not working
# Solution: Use named volumes or absolute paths in bind mounts
#
# ============================================================================
