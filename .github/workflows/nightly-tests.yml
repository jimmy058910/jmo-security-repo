---
name: Nightly Extended Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write  # For creating issue on failure

jobs:
  extended-tests:
    name: Extended Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Extended tests can take longer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Install security tools
        run: |
          # Install critical tools for testing
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
          pip install bandit

      - name: Run full test suite (including slow tests)
        run: |
          pytest tests/ \
            --cov=scripts \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-report=xml \
            -v \
            --durations=20 \
            --maxfail=5

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: nightly
          name: nightly-coverage

      - name: Run performance benchmarks
        run: |
          pytest tests/performance/ -v --tb=short || echo "Performance tests completed with warnings"

      - name: Run load tests
        run: |
          pytest tests/performance/test_load.py -v --tb=short || echo "Load tests completed with warnings"

      - name: Run security audit
        run: |
          echo "ðŸ”’ Running security audit..."
          bandit -r scripts/ -c bandit.yaml

          echo ""
          echo "ðŸ” Scanning for secrets..."
          trufflehog filesystem . --json --exclude-paths .trufflehog-exclude.txt > trufflehog-results.json || true

          # Check for verified secrets
          VERIFIED=$(jq -r 'select(.Verified == true)' trufflehog-results.json 2>/dev/null | wc -l || echo "0")
          if [ "$VERIFIED" -gt 0 ]; then
            echo "âŒ Found $VERIFIED verified secrets!"
            exit 1
          else
            echo "âœ… No verified secrets found"
          fi

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: nightly-test-results
          path: |
            htmlcov/
            coverage.xml
            trufflehog-results.json
          retention-days: 7

  cross-platform-tests:
    name: Cross-Platform Tests (${{ matrix.os }} / Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run unit tests (platform-agnostic)
        run: |
          pytest tests/unit/ \
            --cov=scripts \
            --cov-report=term-missing \
            -v \
            --maxfail=5

      - name: Run CLI tests
        run: |
          pytest tests/cli/ -v --maxfail=5

  security-regression-tests:
    name: Security Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run security regression test suite
        run: |
          pytest tests/e2e/test_security_hardening.py -v --tb=short

      - name: Run SQL injection tests
        run: |
          pytest tests/e2e/test_security_hardening.py::TestSQLInjectionPrevention -v

      - name: Run path traversal tests
        run: |
          pytest tests/e2e/test_security_hardening.py::TestPathTraversalPrevention -v

  docker-smoke-tests:
    name: Docker Smoke Tests
    runs-on: ubuntu-latest
    # Removed timeout-minutes to allow WSL2 builds to complete (BUG #16)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (balanced variant)
        run: |
          docker build -t jmo-security:nightly-test -f Dockerfile.balanced .

      - name: Test Docker image --help
        run: |
          docker run --rm jmo-security:nightly-test --help

      - name: Test Docker scan command
        run: |
          docker run --rm jmo-security:nightly-test scan --help

      - name: Scan test repository with Docker
        run: |
          mkdir -p test-repo results
          echo "print('test')" > test-repo/test.py
          docker run --rm \
            -v "$PWD/test-repo:/scan" \
            -v "$PWD/results:/results" \
            jmo-security:nightly-test scan \
              --repo /scan \
              --results-dir /results \
              --allow-missing-tools

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [extended-tests, cross-platform-tests, security-regression-tests, docker-smoke-tests]
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `Nightly test suite failed on ${today}`;

            const body = `## Nightly Test Failure

            The nightly test suite failed. Please investigate and fix.

            **Failed jobs:**
            ${{ toJSON(needs) }}

            **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Troubleshooting:**
            1. Check workflow logs for specific failures
            2. Run tests locally: \`pytest tests/ -v\`
            3. Check for flaky tests or environmental issues
            4. Review recent commits for potential breaking changes

            /cc @jimmy058910
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-test-failure'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title === title
            );

            if (!existingIssue) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'ci', 'nightly-test-failure']
              });
            } else {
              // Add comment to existing issue
              const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Nightly tests failed again on ${today}.\n\nWorkflow run: ${workflowUrl}`
              });
            }
