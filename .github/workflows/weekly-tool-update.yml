name: Weekly Tool Update

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-update-tools:
    name: Auto-update all security tools
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests packaging

      - name: Check for tool updates
        id: check
        run: |
          echo "Checking for available tool updates..."
          python3 scripts/dev/update_versions.py --check-latest > check_output.txt || true
          cat check_output.txt

          # Check if any updates are available
          if grep -q "UPDATE AVAILABLE" check_output.txt; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available"
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  All tools already up-to-date"
          fi

      - name: Update all tools to latest versions
        if: steps.check.outputs.updates_available == 'true'
        run: |
          echo "Updating all tools to latest versions..."
          python3 scripts/dev/update_versions.py --update-all

          echo ""
          echo "Syncing changes to Dockerfiles..."
          python3 scripts/dev/update_versions.py --sync

      - name: Commit changes
        if: steps.check.outputs.updates_available == 'true'
        id: commit
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create branch for updates
          BRANCH="auto-update-tools-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"

          # Stage changes
          git add versions.yaml Dockerfile Dockerfile.slim Dockerfile.alpine

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create commit message
          cat > commit_message.txt << 'COMMIT_MSG'
          deps(tools): weekly auto-update of security tools

          Automated weekly update of all security tools to latest versions.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          COMMIT_MSG

          # Commit changes
          git commit -F commit_message.txt

          # Push branch
          git push origin "$BRANCH"

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ steps.commit.outputs.branch }}"

          # Create PR body
          cat > pr_body.txt << 'PR_BODY'
          ## Weekly Security Tool Updates

          This PR automatically updates all security tools to their latest versions.

          ### Verification

          - All tools updated via `update_versions.py --update-all`
          - Dockerfiles synced via `update_versions.py --sync`
          - CI tests will verify compatibility

          ### Auto-Merge Policy

          This PR will auto-merge if:
          - âœ… All CI tests pass
          - âœ… No conflicts with main branch
          - âœ… Version consistency check passes

          ---

          ðŸ¤– **Automated PR** - Generated by weekly-tool-update workflow
          ðŸ“… **Schedule**: Every Sunday at 00:00 UTC
          ðŸ”— **Workflow**: `.github/workflows/weekly-tool-update.yml`
          PR_BODY

          # Create PR
          gh pr create \
            --title "deps(tools): weekly auto-update $(date +%Y-%m-%d)" \
            --body-file pr_body.txt \
            --base main \
            --head "$BRANCH" \
            --label "dependencies" \
            --label "automated"

          # Enable auto-merge
          PR_NUMBER=$(gh pr view "$BRANCH" --json number --jq '.number')
          gh pr merge "$PR_NUMBER" --auto --squash

      - name: Summary
        if: always()
        run: |
          {
            echo "## Weekly Tool Update Summary"
            echo ""

            if [[ "${{ steps.check.outputs.updates_available }}" == "true" ]]; then
              if [[ "${{ steps.commit.outputs.has_changes }}" == "true" ]]; then
                echo "âœ… **Updates applied successfully**"
                echo ""
                echo "- Branch created: \`${{ steps.commit.outputs.branch }}\`"
                echo "- Pull request created and set to auto-merge"
                echo "- Will merge automatically when CI passes"
              else
                echo "âš ï¸ **Updates available but no changes committed**"
              fi
            else
              echo "â„¹ï¸ **All tools already up-to-date**"
              echo ""
              echo "No updates needed this week."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
